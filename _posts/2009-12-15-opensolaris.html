---
layout: post
status: publish
published: true
title: OpenSolaris
author:
  display_name: Andrew Kroh
  login: akroh
  email: andy@crowbird.com
  url: ''
author_login: akroh
author_email: andy@crowbird.com
wordpress_id: 119
wordpress_url: https://blog.crowbird.com/blog/?p=119
date: '2009-12-15 00:29:21 -0500'
date_gmt: '2009-12-15 04:29:21 -0500'
categories:
- Solaris
tags: []
comments: []
---
<p><strong>Update (February 2011):<&#47;strong> Oracle stopped contributing to the OpenSolaris project so it is basically dead. However you can use Oracle Solaris 11 Express at no cost under the Oracle Technology Network Developer license if you are developing, testing, or prototyping applications.</p>
<p>For a long time I have been using Gentoo Linux to run a multipurpose server in my home. I mainly use the server to backup data, host web pages, host a CVS server, and run a proxy server. The hardware is rather modest -- Celeron D 2.93GHz, 512MB, 500GB SATA.</p>
<p>As a data backup server I usually copy files to the server over samba and keep the the original on another machine. This keeps me protected in case of a drive failure. But as a backup strategy I'm not happy because I'd like to be able to move a file to backup server and delete the original. To ensure data on the backup server is protected against loss I need some sort of RAID (Redundant Array of Inexpensive Disks). I considered hardware RAID but ultimately ended up going with software RAID (mostly due to the cost difference).</p>
<p>While searching for the best way to implement software RAID I found OpenSolaris and ZFS. ZFS is OpenSolaris's file system which has features like snapshots, copy-on-write, RAID, automatic integrity checking, and automatic repair. Snapshots are similar to the Time Machine feature in Mac OS X. With all these features I thought it would be great to migrate and give Solaris a try.</p>
<p>I upgraded the computer to have 2.5 GB of RAM and purchased a second SATA drive of 1.5 TB. I had planned to use the new drive in conjunction with the old drive to create 500GB of redundant storage plus an addition 1TB of non-redundant storage. Unfortunately, I found that 1.5TB drive is too large for a 32-bit kernel under OpenSolaris and that it is not possible to create redundant storage using two different size drives without the excess size of the larger disk going unused. The maximum drive size supported by a 32-bit kernel on OpenSolaris is 1TB (assuming that the drive is using standard 512 byte blocks). See this <a href="http:&#47;&#47;opensolaris.org&#47;jive&#47;thread.jspa?messageID=418900">thread <&#47;a>in the OpenSolaris forums.</p>
<p>Ultimately I decided to purchase two 1TB drives and just run everything from them. I'll make use the old 500GB drive and the 1.5TB drive in another PC.</p>
<h3>Services<&#47;h3></p>
<p>These are the services that the Solaris box provides.</p>
<table>
<tr>
<td><strong>Web Server<&#47;strong> - Sun Java System Web Server - Used to host ViewVC (a web based CVS browser), Gallery (open source photo album organizer), a custom PHP based video browser, and give web based access to backed up files.<&#47;td><br />
<&#47;tr></p>
<tr>
<td><strong>CVS<&#47;strong> - Used to version control various software projects and configuration files.<&#47;td><br />
<&#47;tr></p>
<tr>
<td><strong>HTTP Proxy&#47;Cache<&#47;strong> - Squid - Used to proxy web traffic when I'm connected to a public network. I use ssh to create a secure tunnel to the proxy server so that my web traffic cannot be intercepted or analyzed while connected to a public network like a hotel or a Starbucks.<&#47;td><br />
<&#47;tr></p>
<tr>
<td><strong>SMB&#47;CIFS<&#47;strong> - Used to provide Windows and Mac access to the file server. Solaris has built in support for CIFS (Common Internet File System) and supports access control lists (ACLs).<&#47;td><br />
<&#47;tr></p>
<tr>
<td><strong>iSCSI<&#47;strong> - Used to create an iSCSI drive on Mac that Time Machine can use as a backup disk. Mac OS X doesn't have an iSCSI Initiator built it but Studio Network Solutions has a free one.<&#47;td><br />
<&#47;tr><br />
<&#47;table></p>
<h3>Setup<&#47;h3></p>
<h4>OS Installation<&#47;h4><br />
Install OpenSolaris from the downloadable Live CD. During the interactive installation choose one of the drives and use the whole disk. After installation is completed you will attach the second disk to create a mirror. Instructions are located <a href="http:&#47;&#47;dlc.sun.com&#47;osol&#47;docs&#47;content&#47;2008.11&#47;getstart&#47;sliminstall.html">here<&#47;a>.</p>
<h4>Post-Installation Setup<&#47;h4><br />
I like to customize my bash environment. Run these commands to add some aliases that are sourced when a bash shell is opened. Of course this is completely optional.</p>
<p>[bash gutter="false"]<br />
cd ~<br />
echo source .bashrc > .bash_profile<br />
echo alias l=\'ls -la\' >> .bashrc<br />
echo alias cdh=\'cd ~\' >> .bashrc[&#47;bash]</p>
<h4>Configuring a Static IP Address<&#47;h4><br />
By default DHCP will be enabled after installation. You will probably want to configure a static IP address for you server. Replace rtls0 with the name of your network interface card (NIC).</p>
<p>[bash gutter="false"]# Disable DHCP<br />
$ svcadm disable nwam<br />
$ rm &#47;etc&#47;dhcp.rtls0</p>
<p># Edit &#47;etc&#47;hosts<br />
# Add a line (this file and &#47;etc&#47;inet&#47;ipnodes are symlinks to &#47;etc&#47;inet&#47;hosts)<br />
192.168.0.10 kermit.domain.local kermit</p>
<p># Edit &#47;etc&#47;netmasks<br />
# Ensure that it contains a line like this<br />
192.168.0.0    255.255.255.0</p>
<p># Edit &#47;etc&#47;nsswitch.conf<br />
# Make the hosts: line contain this<br />
host: files dns</p>
<p># Edit &#47;etc&#47;hostname.rtls0<br />
# This file describes the hostname of the interface<br />
# It can be either an IP address or a hostname in &#47;etc&#47;hosts<br />
kermit</p>
<p># Edit &#47;etc&#47;defaultrouter<br />
# This should contain the IP address of your gateway<br />
192.168.0.1</p>
<p># Edit &#47;etc&#47;resolve.conf<br />
# This file describes the DNS servers to use (these<br />
# are for Google DNS followed by my router)<br />
nameserver 8.8.8.8<br />
nameserver 8.8.4.4<br />
nameserver 192.168.0.1</p>
<p># Reset your NIC<br />
$ svcadm disable network&#47;physical:default<br />
$ svcadm enable network&#47;physical:default<br />
[&#47;bash]</p>
<h4>Creating a ZFS Mirror Pool<&#47;h4><br />
The first step is to prepare the second disk by formatting it entirely as a Solaris partition.</p>
<p>[bash gutter="false"]$ format<br />
Searching for disks...done</p>
<p>AVAILABLE DISK SELECTIONS:<br />
       0. c8d0 <DEFAULT cyl 60797 alt 2 hd 255 sec 126><br />
          &#47;pci@0,0&#47;pci-ide@1f,2&#47;ide@0&#47;cmdk@0,0<br />
       1. c9d0 <DEFAULT cyl 60797 alt 2 hd 255 sec 126><br />
          &#47;pci@0,0&#47;pci-ide@1f,2&#47;ide@1&#47;cmdk@0,0<br />
Specify disk (enter its number): 2<br />
format> fdisk</p>
<p>No fdisk table exists. The default partition for the disk is:</p>
<p>  a 100% "SOLARIS System" partition</p>
<p>Type "y" to accept the default partition,  otherwise type "n" to edit the<br />
 partition table.<br />
y[&#47;bash]</p>
<p>Enter "y" and the disk will be formatted.</p>
<p>The next step is to copy the volume table of contents from the first drive to the second drive.</p>
<p><code>$ prtvtoc &#47;dev&#47;rdsk&#47;c8d0s0 | &#47;usr&#47;sbin&#47;fmthard -s - &#47;dev&#47;rdsk&#47;c9d0s0<br />
fmthard:  New volume table of contents now in place.<&#47;code></p>
<p>Now the second disk is prepared to be attached to the storage pool to create a mirror.</p>
<p><code>$ zpool attach rpool c8d0s0 c9d0s0<br />
invalid vdev specification<br />
use '-f' to override the following errors:<br />
&#47;dev&#47;dsk&#47;c8d0s0 overlaps with &#47;dev&#47;dsk&#47;c9d0s2<br />
$ zpool attach -f rpool c8d0s0 c9d0s0<&#47;code></p>
<p>Make sure to wait until resilver is done before rebooting.</p>
<p>In the case of a disk failure you would want the second disk to be bootable so we should install grub and a MBR to the second disk.</p>
<p><code>$ installgrub -m &#47;boot&#47;grub&#47;stage1 &#47;boot&#47;grub&#47;stage2 &#47;dev&#47;rdsk&#47;c9d0s0<br />
Updating master boot sector destroys existing boot managers (if any).<br />
continue(y&#47;n)?y<br />
stage1 written to partition 0 sector 0 (abs 32130)<br />
stage2 written to partition 0, 271 sectors starting at 50 (abs 32180)<br />
stage1 written to master boot sector<&#47;code></p>
<p>The filesystem should be replicating data from the first disk to the second disk. You can check on progress by issuing the zpool status command.</p>
<p><code>$ zpool status<br />
  pool: rpool<br />
 state: ONLINE<br />
status: One or more devices is currently being resilvered.  The pool will<br />
        continue to function, possibly in a degraded state.<br />
action: Wait for the resilver to complete.<br />
 scrub: resilver in progress for 0h1m, 1.81% done, 1h11m to go<br />
config:</p>
<p>        NAME        STATE     READ WRITE CKSUM<br />
        rpool       ONLINE       0     0     0<br />
          mirror    ONLINE       0     0     0<br />
            c8d0s0  ONLINE       0     0     0<br />
            c9d0s0  ONLINE       0     0     0  2.06G resilvered</p>
<p>errors: No known data errors<br />
<&#47;code></p>
<h3>Miscellaneous Tasks<&#47;h3></p>
<h4>Mounting ext3 Drives as Read-Only on Solaris<&#47;h4><br />
Download and install (using pkgadd) <a href="http:&#47;&#47;www.belenix.org&#47;distributions&#47;belenix_site&#47;binfiles&#47;FSWpart.tar.gz">FSWpart.tar.gz<&#47;a> and <a href="http:&#47;&#47;www.belenix.org&#47;distributions&#47;belenix_site&#47;binfiles&#47;FSWfsmisc.tar.gz">FSWfsmisc.tar.gz<&#47;a> from <a href="http:&#47;&#47;www.belenix.org&#47;?q=download">http:&#47;&#47;www.belenix.org&#47;?q=download<&#47;a>.</p>
<p><code>$ gunzip -c FSWpart.tar.gz | tar xvf -<br />
$ pkgadd -d . FSWpart<br />
$ gunzip -c FSWfsmisc.tar.gz | tar xvf -<br />
$ pkgadd -d . FSWfsmisc<&#47;code></p>
<p>Use format to list the attached hard disks.</p>
<p><code>$ format<br />
AVAILABLE DISK SELECTIONS:<br />
       0. c8d0 <DEFAULT cyl 60797 alt 2 hd 255 sec 126><br />
          &#47;pci@0,0&#47;pci-ide@1f,2&#47;ide@0&#47;cmdk@0,0<br />
       1. c9d0 <DEFAULT cyl 60797 alt 2 hd 255 sec 126><br />
          &#47;pci@0,0&#47;pci-ide@1f,2&#47;ide@1&#47;cmdk@0,0<&#47;code></p>
<p>Exit format using Control-C.</p>
<p>Use prtpart to display the partions on the disk.<br />
<code>$ prtpart &#47;dev&#47;rdsk&#47;c8d0p0 -ldevs<&#47;code></p>
<p>Now mount the disk read-only.</p>
<p><code>$ mount -F ext2fs -o ro &#47;dev&#47;rdsk&#47;c8d0p0 &#47;mount_location<&#47;code></p>
<p>To unmount the partition use xumount so that the background NFS process is terminated.</p>
<p><code>$ xumount &#47;mount_location<&#47;code></p>
<p>The xlsmounts tool can be used to list all ext3 mounted partitions.</p>
<p><code>$ xlsmounts</p>
<p>  PHYSICAL DEVICE                 LOGICAL DEVICE      FS    PID         ADDR Mounted on<br />
  &#47;dev&#47;dsk&#47;c2t0d0p1              &#47;dev&#47;dsk&#47;c2t0d0p1    ntfs  6755        127.0.0.1:&#47; &#47;mnt<&#47;code></p>

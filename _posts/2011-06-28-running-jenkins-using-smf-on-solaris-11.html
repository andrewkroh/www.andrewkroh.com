---
layout: post
status: publish
published: true
title: Running Jenkins using SMF on Solaris 11
author:
  display_name: Andrew Kroh
  login: akroh
  email: andy@crowbird.com
  url: ''
author_login: akroh
author_email: andy@crowbird.com
wordpress_id: 153
wordpress_url: https://blog.crowbird.com/blog/?p=153
date: '2011-06-28 01:16:34 -0400'
date_gmt: '2011-06-28 05:16:34 -0400'
categories:
- Solaris
tags:
- solaris11
comments: []
---
<p>Jenkins (formerly known as Hudson) is a continuous integration tool. Installing Jenkins as a daemon service on Solaris 11 is pretty simple. Below are the steps I took to get it up and running using SMF in Solaris 11. SMF or Service Management Facility is the default way to manage services in Solaris 10 and 11.</p>
<h4>Create New User to Run Jenkins<&#47;h4><br />
[bash gutter="false"]<br />
groupadd jenkins<br />
useradd -g jenkins -d &#47;export&#47;home&#47;jenkins -m -s &#47;bin&#47;bash jenkins<br />
passwd jenkins[&#47;bash]</p>
<h4>Configure the User's Environment<&#47;h4><br />
[bash gutter="false"]<br />
sudo su - jenkins<br />
mkdir workspace<br />
wget http:&#47;&#47;mirrors.jenkins-ci.org&#47;war-stable&#47;latest&#47;jenkins.war<br />
echo source .bashrc > .bash_profile<br />
[&#47;bash]</p>
<p>Create a .bashrc with the appropriate settings for your jenkins user.</p>
<p>[bash title="Listing: &#47;export&#47;home&#47;jenkins&#47;.bashrc"]<br />
# Define default prompt to <username>@<hostname>:
<path><"($|#) "><br />
# and print '#' for user "root" and '$' for normal users.<br />
#<br />
typeset +x PS1="\u@\h:\w\\$ "<br />
alias l='ls -lah'<br />
alias cdh='cd ~'</p>
<p># CVS over SSH Configuration (assuming local server)<br />
host=`hostname`<br />
export CVS_RSH=ssh<br />
export CVSROOT=:ext:jenkins@$host:&#47;var&#47;cvs</p>
<p># Gradle Options<br />
GRADLE_OPTS="-Dorg.gradle.daemon=true"<br />
[&#47;bash]</p>
<p>Create a start_jenkins.sh script.</p>
<p>[bash title="Listing: &#47;export&#47;home&#47;jenkins&#47;start_jenkins.sh"]<br />
#!&#47;bin&#47;sh<br />
source &#47;export&#47;home&#47;jenkins&#47;.bashrc<br />
HTTP_HOST="127.0.0.1"<br />
HTTP_PORT="7777"</p>
<p>export JENKINS_HOME=&#47;export&#47;home&#47;jenkins&#47;workspace</p>
<p>java -Dmail.smtp.starttls.enable=true -jar &#47;export&#47;home&#47;jenkins&#47;jenkins.war --prefix=&#47;jenkins --httpListenAddress=$HTTP_HOST --httpPort=$HTTP_PORT<br />
[&#47;bash]</p>
<p>Add execute permissions to the new script.</p>
<p>[bash gutter="false"]<br />
chmod a+x start_jenkins.sh<br />
[&#47;bash]</p>
<h4>Configure SSH to allow CVS only for Jenkins<&#47;h4></p>
<p>Generate a SSH key for jenkins.</p>
<p>[bash gutter="false"]<br />
cd ~&#47;.ssh<br />
ssh-keygen -t dsa<br />
[&#47;bash]</p>
<p>Append the contents of <code>id_dsa.pub<&#47;code> to the <code>~&#47;.ssh&#47;authorized_keys2<&#47;code> file on the system that you want to allow you to log in to.</p>
<p>Add <code>command="&#47;usr&#47;bin&#47;cvs server",no-port-forwarding,no-X11-forwarding,no-agent-forwarding"<&#47;code> to the beginning of the line you just appended to limit the commands that Jenkins can execute when SSH'ing to the server.</p>
<p>Test your SSH connection once so that you can accept the server's key or else Jenkins will hang on the first CVS checkout.</p>
<h4>Configure SMF to Start Jenkins as a Service<&#47;h4></p>
<p>You need to load a manifest file into SMF that tells it how to run Jenkins. Place the following manifest file in &#47;var&#47;svc&#47;manifest&#47;application and then load it into SMF using svccfg.</p>
<p>[xml title="Listing: &#47;var&#47;svc&#47;manifest&#47;application&#47;jenkins.xml"]<br />
<?xml version='1.0'?></p>
<p><!DOCTYPE service_bundle SYSTEM '&#47;usr&#47;share&#47;lib&#47;xml&#47;dtd&#47;service_bundle.dtd.1'></p>
<p><service_bundle type="manifest" name="Jenkins"><br />
    <service name="application&#47;jenkins" type="service" version="1"><br />
       <create_default_instance enabled="false"&#47;><br />
       <single_instance&#47;></p>
<p>       <method_context><br />
           <method_credential user='jenkins' group='jenkins'&#47;></p>
<p>           <method_environment><br />
               <envvar name='PATH' value='&#47;usr&#47;bin:&#47;usr&#47;local&#47;bin'&#47;><br />
           <&#47;method_environment><br />
       <&#47;method_context></p>
<p>       <exec_method type="method" name="start" exec="&#47;export&#47;home&#47;jenkins&#47;start_jenkins.sh" timeout_seconds="0"&#47;></p>
<p>       <exec_method type="method" name="stop" exec=":kill -TERM" timeout_seconds="30"&#47;></p>
<property_group name='startd' type='framework'>
<propval name='duration' type='astring' value='child'&#47;>
       <&#47;property_group></p>
<p>       <stability value="Evolving"&#47;></p>
<p>       <template><br />
           <common_name><br />
               <loctext xml:lang='C'>Jenkins Continuous Build Server<&#47;loctext><br />
           <&#47;common_name></p>
<p>           <documentation><br />
               <doc_link name='jenkins-ci.org' uri='http:&#47;&#47;jenkins-ci.org&#47;'&#47;><br />
           <&#47;documentation><br />
       <&#47;template><br />
    <&#47;service><br />
<&#47;service_bundle><br />
[&#47;xml]</p>
<p>Now with the manifest file on your system. It's time to load it into SMF.</p>
<p>[bash gutter="false"]<br />
svcadm restart svc:&#47;system&#47;manifest-import<br />
svcadm enable jenkins<br />
[&#47;bash]</p>
<p>You can verify that it started by running this command and checking the state.</p>
<p><code>$ svcs -l jenkins<br />
fmri         svc:&#47;application&#47;jenkins:default<br />
name         Jenkins Continuous Build Server<br />
enabled      true<br />
state        online<br />
next_state   none<br />
state_time   June 28, 2011 09:06:45 PM EDT<br />
logfile      &#47;var&#47;svc&#47;log&#47;application-jenkins:default.log<br />
restarter    svc:&#47;system&#47;svc&#47;restarter:default<br />
contract_id  7207<&#47;code></p>
<p>If you need to debug something you can have a look at the log file for your jenkins service at <code>&#47;var&#47;svc&#47;log&#47;application-jenkins:default.log<&#47;code>.</p>
<h4>Bonus: Running Jenkins Behind Apache using Reverse Proxy<&#47;h4></p>
<p>I already have a web service running on port 80, and I wanted to be able to access Jenkins through that port. To do this I added a reverse proxy in Apache. If you have any access controls in your apache configuration then its important that you set the host address to 127.0.0.1 so that someone can't go around your proxy and hit Jenkins directly. Add the following to your httpd.conf to be able to access Jenkins.</p>
<p>[xml]<br />
# Reverse proxy to Jenkins:<br />
ProxyPass &#47;jenkins http:&#47;&#47;localhost:7777&#47;jenkins<br />
ProxyPassReverse &#47;jenkins http:&#47;&#47;localhost:7777&#47;jenkins</p>
<p># Allow access to this proxy to everyone:<br />
<Proxy http:&#47;&#47;localhost:7777&#47;jenkins*><br />
    Order deny,allow<br />
    Allow from all<br />
<&#47;Proxy>[&#47;xml]</p>
